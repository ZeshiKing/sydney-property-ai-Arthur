<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯ç›´æ¥çˆ¬å– - Domain.com.au</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .scraper-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        input, select, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
        }
        .property-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .property-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .property-details {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 14px;
            color: #666;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .csv-section {
            background: #e9f7ef;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ•·ï¸ Domain.com.au å‰ç«¯çˆ¬å–å™¨</h1>
        <p>âš ï¸ æ³¨æ„ï¼šç”±äºCORSé™åˆ¶ï¼Œæ­¤æ–¹æ³•éœ€è¦æµè§ˆå™¨æ’ä»¶æˆ–ä»£ç†</p>
        
        <!-- æ–¹æ³•1: ä»£ç†çˆ¬å– -->
        <div class="scraper-section">
            <h2>æ–¹æ³•1: é€šè¿‡ä»£ç†APIçˆ¬å–</h2>
            <p>ä½¿ç”¨CORSä»£ç†ç»•è¿‡è·¨åŸŸé™åˆ¶</p>
            
            <div class="controls">
                <input type="text" id="location1" placeholder="åœ°åŒº (å¦‚: Camperdown)" value="Camperdown">
                <input type="number" id="minPrice1" placeholder="æœ€ä½ä»·æ ¼" value="500">
                <input type="number" id="maxPrice1" placeholder="æœ€é«˜ä»·æ ¼" value="1000">
                <select id="bedrooms1">
                    <option value="">ä»»æ„å§å®¤</option>
                    <option value="1">1å®¤</option>
                    <option value="2" selected>2å®¤</option>
                    <option value="3">3å®¤</option>
                    <option value="4">4å®¤+</option>
                </select>
                <button onclick="scrapeWithProxy()" id="proxyBtn">å¼€å§‹çˆ¬å–</button>
            </div>
            
            <div id="proxyLog" class="log-area" style="display:none;"></div>
            <div id="proxyResults" class="results"></div>
        </div>
        
        <!-- æ–¹æ³•2: ç”¨æˆ·æä¾›æ•°æ® -->
        <div class="scraper-section">
            <h2>æ–¹æ³•2: æ‰‹åŠ¨æä¾›é¡µé¢æ•°æ®</h2>
            <p>ç”¨æˆ·è®¿é—®Domain.com.auï¼Œå¤åˆ¶é¡µé¢æºç åˆ°è¿™é‡Œå¤„ç†</p>
            
            <div class="controls">
                <input type="url" id="domainUrl" placeholder="Domain.com.auæœç´¢ç»“æœé¡µé¢URL" style="width: 400px;">
                <button onclick="openDomainPage()">æ‰“å¼€Domainé¡µé¢</button>
            </div>
            
            <textarea id="htmlContent" placeholder="è¯·å°†Domain.com.aué¡µé¢çš„HTMLæºç ç²˜è´´åˆ°è¿™é‡Œ..." 
                     style="width: 100%; height: 150px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
            
            <div class="controls">
                <button onclick="parseHTMLContent()">è§£ææ•°æ®</button>
                <button onclick="sendToBackend()">å‘é€åˆ°åç«¯å¤„ç†</button>
            </div>
            
            <div id="manualResults" class="results"></div>
        </div>
        
        <!-- CSVæ•°æ®ç®¡ç† -->
        <div class="csv-section">
            <h2>ğŸ“Š CSVæ•°æ®ç®¡ç†</h2>
            <div class="controls">
                <button onclick="downloadCSV()">ä¸‹è½½CSV</button>
                <button onclick="uploadToBackend()">ä¸Šä¼ åˆ°åç«¯</button>
                <button onclick="clearData()">æ¸…ç©ºæ•°æ®</button>
                <span id="dataCount">å½“å‰æ•°æ®ï¼š0æ¡</span>
            </div>
        </div>
    </div>

    <script>
        let scrapedData = [];
        
        function log(area, message, type = 'info') {
            const logArea = document.getElementById(area + 'Log');
            logArea.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'color: red' : type === 'success' ? 'color: green' : 'color: black';
            
            logArea.innerHTML += `<div style="${className}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // æ–¹æ³•1: ä½¿ç”¨ä»£ç†APIçˆ¬å–
        async function scrapeWithProxy() {
            const btn = document.getElementById('proxyBtn');
            btn.disabled = true;
            btn.textContent = 'çˆ¬å–ä¸­...';
            
            try {
                log('proxy', 'å¼€å§‹æ„å»ºæœç´¢URL...');
                
                const location = document.getElementById('location1').value;
                const minPrice = document.getElementById('minPrice1').value;
                const maxPrice = document.getElementById('maxPrice1').value;
                const bedrooms = document.getElementById('bedrooms1').value;
                
                // æ„å»ºDomain.com.au URL
                let domainUrl = 'https://www.domain.com.au/rent/';
                const params = [];
                
                if (location) {
                    params.push(`suburb=${location.toLowerCase().replace(/\s+/g, '-')}`);
                }
                if (minPrice) {
                    params.push(`price=${minPrice}-${maxPrice || 'any'}`);
                }
                if (bedrooms) {
                    params.push(`bedrooms=${bedrooms}`);
                }
                
                if (params.length > 0) {
                    domainUrl += '?' + params.join('&');
                }
                
                log('proxy', `ç›®æ ‡URL: ${domainUrl}`);
                
                // å°è¯•ä½¿ç”¨å…¬å…±CORSä»£ç†
                const proxyUrls = [
                    'https://api.allorigins.win/get?url=',
                    'https://cors-anywhere.herokuapp.com/',
                    'https://corsproxy.io/?'
                ];
                
                for (const proxy of proxyUrls) {
                    try {
                        log('proxy', `å°è¯•ä»£ç†: ${proxy}`);
                        
                        const response = await fetch(proxy + encodeURIComponent(domainUrl));
                        let htmlContent;
                        
                        if (proxy.includes('allorigins')) {
                            const data = await response.json();
                            htmlContent = data.contents;
                        } else {
                            htmlContent = await response.text();
                        }
                        
                        if (htmlContent && htmlContent.length > 1000) {
                            log('proxy', 'æˆåŠŸè·å–é¡µé¢æ•°æ®ï¼Œå¼€å§‹è§£æ...', 'success');
                            const properties = parsePropertyHTML(htmlContent);
                            displayResults('proxyResults', properties);
                            scrapedData = properties;
                            updateDataCount();
                            return;
                        }
                    } catch (e) {
                        log('proxy', `ä»£ç†å¤±è´¥: ${e.message}`, 'error');
                    }
                }
                
                log('proxy', 'æ‰€æœ‰ä»£ç†éƒ½å¤±è´¥äº†ï¼Œè¯·å°è¯•æ–¹æ³•2', 'error');
                
            } catch (error) {
                log('proxy', `çˆ¬å–å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'å¼€å§‹çˆ¬å–';
            }
        }
        
        // æ–¹æ³•2: è§£æç”¨æˆ·æä¾›çš„HTMLå†…å®¹
        function parseHTMLContent() {
            const htmlContent = document.getElementById('htmlContent').value.trim();
            
            if (!htmlContent) {
                alert('è¯·å…ˆç²˜è´´HTMLå†…å®¹');
                return;
            }
            
            try {
                const properties = parsePropertyHTML(htmlContent);
                displayResults('manualResults', properties);
                scrapedData = properties;
                updateDataCount();
                
                alert(`æˆåŠŸè§£æ ${properties.length} ä¸ªæˆ¿äº§ä¿¡æ¯ï¼`);
            } catch (error) {
                alert(`è§£æå¤±è´¥: ${error.message}`);
            }
        }
        
        // HTMLè§£æå‡½æ•°
        function parsePropertyHTML(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const properties = [];
            
            // Domain.com.auçš„å¸¸è§é€‰æ‹©å™¨
            const selectors = [
                '[data-testid="listing-card"]',
                '.listing-card',
                '.property-card',
                'article[data-testid*="listing"]',
                '.css-1qp9106'  // Domainçš„å¸¸ç”¨ç±»å
            ];
            
            let propertyElements = [];
            for (const selector of selectors) {
                propertyElements = doc.querySelectorAll(selector);
                if (propertyElements.length > 0) break;
            }
            
            console.log(`æ‰¾åˆ° ${propertyElements.length} ä¸ªæˆ¿äº§å…ƒç´ `);
            
            propertyElements.forEach((element, index) => {
                try {
                    const property = {
                        id: `prop_${Date.now()}_${index}`,
                        title: extractText(element, [
                            '[data-testid="listing-card-title"]',
                            '.listing-card__title',
                            'h2 a',
                            'h3 a',
                            '.property-title'
                        ]),
                        price: extractText(element, [
                            '[data-testid="listing-card-price"]',
                            '.property-price',
                            '.listing-card__price',
                            '.css-mgq8yx'
                        ]),
                        location: extractText(element, [
                            '[data-testid="listing-card-suburb"]',
                            '.listing-card__suburb',
                            '.property-address',
                            '.css-694pno'
                        ]),
                        bedrooms: extractNumber(element, ['bed', 'br']),
                        bathrooms: extractNumber(element, ['bath', 'ba']),
                        parking: extractNumber(element, ['car', 'park']),
                        url: extractURL(element),
                        scraped_at: new Date().toISOString(),
                        source: 'Domain.com.au (Frontend)'
                    };
                    
                    // åªæ·»åŠ æœ‰æ•ˆæ•°æ®
                    if (property.title || property.price) {
                        properties.push(property);
                    }
                } catch (error) {
                    console.warn(`è§£æç¬¬${index}ä¸ªæˆ¿äº§å¤±è´¥:`, error);
                }
            });
            
            return properties;
        }
        
        // è¾…åŠ©è§£æå‡½æ•°
        function extractText(element, selectors) {
            for (const selector of selectors) {
                const found = element.querySelector(selector);
                if (found && found.textContent.trim()) {
                    return found.textContent.trim();
                }
            }
            return '';
        }
        
        function extractNumber(element, keywords) {
            const text = element.textContent.toLowerCase();
            for (const keyword of keywords) {
                const match = text.match(new RegExp(`(\\d+)\\s*${keyword}`));
                if (match) return parseInt(match[1]);
            }
            return null;
        }
        
        function extractURL(element) {
            const link = element.querySelector('a[href]');
            if (link) {
                const href = link.getAttribute('href');
                if (href.startsWith('http')) return href;
                if (href.startsWith('/')) return 'https://www.domain.com.au' + href;
            }
            return '';
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(containerId, properties) {
            const container = document.getElementById(containerId);
            
            if (properties.length === 0) {
                container.innerHTML = '<p>æœªæ‰¾åˆ°æˆ¿äº§æ•°æ®</p>';
                return;
            }
            
            let html = `<h3>æ‰¾åˆ° ${properties.length} ä¸ªæˆ¿äº§</h3>`;
            
            properties.forEach(prop => {
                html += `
                    <div class="property-item">
                        <div class="property-title">${prop.title || 'æ— æ ‡é¢˜'}</div>
                        <div class="property-details">
                            <span>ğŸ’° ${prop.price || 'N/A'}</span>
                            <span>ğŸ“ ${prop.location || 'N/A'}</span>
                            <span>ğŸ›ï¸ ${prop.bedrooms || 'N/A'}å®¤</span>
                            <span>ğŸ› ${prop.bathrooms || 'N/A'}å«</span>
                            <span>ğŸš— ${prop.parking || 'N/A'}è½¦ä½</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // æ‰“å¼€Domainé¡µé¢
        function openDomainPage() {
            const url = document.getElementById('domainUrl').value || 'https://www.domain.com.au/rent/';
            window.open(url, '_blank');
            
            alert('è¯·åœ¨æ–°æ‰“å¼€çš„é¡µé¢ä¸­:\n1. è¿›è¡Œæˆ¿äº§æœç´¢\n2. å³é”® â†’ æŸ¥çœ‹é¡µé¢æºä»£ç \n3. å¤åˆ¶å…¨éƒ¨HTMLå†…å®¹\n4. ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†');
        }
        
        // å‘é€åˆ°åç«¯å¤„ç†
        async function sendToBackend() {
            if (scrapedData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å‘é€');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/api/v1/properties/bulk-process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        properties: scrapedData,
                        source: 'frontend_scraper'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`æˆåŠŸå‘é€ ${scrapedData.length} æ¡æ•°æ®åˆ°åç«¯å¤„ç†`);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                alert(`å‘é€å¤±è´¥: ${error.message}\nè¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ`);
            }
        }
        
        // CSVå¯¼å‡ºåŠŸèƒ½
        function downloadCSV() {
            if (scrapedData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            const csvContent = convertToCSV(scrapedData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `domain_properties_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        function convertToCSV(data) {
            const headers = ['ID', 'Title', 'Price', 'Location', 'Bedrooms', 'Bathrooms', 'Parking', 'URL', 'Source', 'Scraped_At'];
            
            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
                const values = [
                    row.id || '',
                    (row.title || '').replace(/,/g, ';'),
                    (row.price || '').replace(/,/g, ';'),
                    (row.location || '').replace(/,/g, ';'),
                    row.bedrooms || '',
                    row.bathrooms || '',
                    row.parking || '',
                    row.url || '',
                    row.source || '',
                    row.scraped_at || ''
                ];
                
                csv += values.join(',') + '\n';
            });
            
            return csv;
        }
        
        function updateDataCount() {
            document.getElementById('dataCount').textContent = `å½“å‰æ•°æ®ï¼š${scrapedData.length}æ¡`;
        }
        
        function clearData() {
            scrapedData = [];
            updateDataCount();
            document.getElementById('proxyResults').innerHTML = '';
            document.getElementById('manualResults').innerHTML = '';
            alert('æ•°æ®å·²æ¸…ç©º');
        }
        
        // ä¸Šä¼ åˆ°åç«¯
        async function uploadToBackend() {
            if (scrapedData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä¸Šä¼ ');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/api/v1/properties/import-csv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        properties: scrapedData,
                        metadata: {
                            source: 'frontend_scraper',
                            scraped_at: new Date().toISOString(),
                            count: scrapedData.length
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`æˆåŠŸä¸Šä¼  ${scrapedData.length} æ¡æ•°æ®åˆ°åç«¯æ•°æ®åº“`);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                alert(`ä¸Šä¼ å¤±è´¥: ${error.message}`);
            }
        }
    </script>
</body>
</html>